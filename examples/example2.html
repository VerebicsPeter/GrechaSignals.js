<!DOCTYPE html>
<html>
  <head><title>Grecha Signals - Todo App</title></head>
  <body>
    <div id="entry"></div>
    <script type="module" src="../grecha.js"></script>
    <script type="module">
      const todos = [
        {id:1, text:"buy milk", done:false},
        {id:2, text:"buy bread", done:false},
      ];

      const [getTodos, setTodos, watchTodos] = state$(todos);

      watchTodos((todos) => console.log("Todos changed:", todos));

      const createTodo = (todo) => {
        const newTodos = getTodos();
        newTodos.push(todo);
        setTodos(newTodos);
      };

      const removeTodo = (todo) => {
        const newTodos = getTodos().filter((other) => other !== todo);
        setTodos(newTodos);
      };

      const STATUSES = {
        "all": "All",
        "done": "Done",
        "todo": "Todo",
      };

      const [filterText] = state$("");
      const [filterDone] = state$("all");

      const [filter] = derived$(
        [filterText, filterDone],
        (text, done) => (todo) => {
          let passDone = false;
          switch (done) {
            case "all":
              passDone = true;
              break;
            case "done":
              passDone = !!todo.done;
              break;
            case "todo":
              passDone = !!todo.done === false;
              break;
          }
          return todo.text.includes(text) && passDone;
        }
      );

      const TodoForm = ({ getTodos, createTodo }) => {
        const [todoText] = state$("");
        const [getTodoId, setTodoId] = state$(getTodos().length);

        const submit = () => {
          if (todoText()) {
            setTodoId(getTodoId() + 1); // increment id
            createTodo({ id: getTodoId(), text: todoText(), done: false });
          } else {
            alert("Please enter todo text.");
          }
        };

        return div(
          p("Create Todo:"),
          div(
            input("text")
              .bind$("value", todoText)
              .on$("keydown", (evt) => evt.key === "Enter" && submit())
          ),
          button("Create Todo").onclick$(submit)
        );
      };
      
      const TodoFilter = ({ filterText, filterDone }) => {
        const filterTextInput = input("text")
          .bind$("value", filterText);
        const filterDoneInput = select(STATUSES)
          .bind$("value", filterDone);
        
        return div(
          p("Filter Todos:"),
          div("Text: ", filterTextInput),
          div("Done: ", filterDoneInput),
        );
      };
      
      const TodoItem = (todo, {filter, removeTodo}) => {
        const [getDone, setDone] = state$(todo.done);
        const [getText, setText] = state$(todo.text);
        
        const [shouldShow] = derived$([filter, getDone, getText],
          (filter, done, text) => {
          // sync UI state to the domain state
          todo.done = done;
          todo.text = text;
          // NOTE: 
          // call the filter instead of adding a watcher for state,
          // this allows for better performance
          return filter(todo);
        });

        return div(
          div("Todo: ", span(getText).style$({ fontWeight: "bold" })),
          div("Done: ", span(ite$(getDone, "Yes", "No"))),

          input("text")
            .bind$("value", setText),

          button("Remove")
            .on$("click", () => removeTodo(todo)),

          button(ite$(getDone, "Mark Todo", "Mark Done"))
            .on$("click", () => setDone(!getDone()))
        )
          .show$(shouldShow)
          .style$({ border: "1px solid black", marginTop: "1px"});
      };

      const root = router({
        "/": div(
          div(
            TodoForm({ getTodos, createTodo })
              .style$({marginRight: "0.5rem"}),
            TodoFilter({ filterText, filterDone })
              .style$({marginRight: "0.5rem"}),
          )
            .style$({display: "flex", marginBottom: "0.5rem"}),
          for$(getTodos, (todo) => TodoItem(todo, { filter, removeTodo }), { id: (todo) => todo.id })
        ),
      });
      entry.appendChild(root);
    </script>
  </body>
</html>
